# Androidå¹³å°FFmpegå®è·µï¼šåŸºæœ¬åŸç†ä¸æºç ç¼–è¯‘

**å…³äºä½œè€…**

>éƒ­å­æ˜Ÿï¼Œç¨‹åºå‘˜ï¼Œå‰ä»–æ‰‹ï¼Œä¸»è¦ä»äº‹Androidå¹³å°åŸºç¡€æ¶æ„æ–¹é¢çš„å·¥ä½œï¼Œæ¬¢è¿äº¤æµæŠ€æœ¯æ–¹é¢çš„é—®é¢˜ï¼Œå¯ä»¥å»æˆ‘çš„[Github](https://github.com/guoxiaoxing)æissueæˆ–è€…å‘é‚®ä»¶è‡³guoxiaoxingse@163.comä¸æˆ‘äº¤æµã€‚

**æ–‡ç« ç›®å½•**

- ä¸€ éŸ³è§†é¢‘ç¼–è§£ç åŸºæœ¬åŸç†
- äºŒ FFmpegæºç ç¼–è¯‘

ä»è¿™ç¯‡æ–‡ç« å¼€å§‹ï¼Œæˆ‘ä»¬å¼€å§‹æ¥äº†è§£FFmpegåœ¨Androidå¹³å°ä¸Šçš„åº”ç”¨ã€‚æœ¬ç¯‡æ–‡ç« ä»‹ç»éŸ³è§†é¢‘ç¼–è§£ç çš„åŸºæœ¬åŸç†ï¼Œæ–‡ç« å†…å¹¶ä¸ä¼šç‰µæ‰¯è¿‡äºå¤æ‚çš„æ¦‚å¿µï¼Œæ—¨åœ¨ç»™å¤§å®¶å¸¦æ¥éŸ³è§†é¢‘ç¼–è§£ç 
é€šè¯†ä¸Šçš„äº†è§£ï¼Œä¸ºåç»­çš„FFmpegä½¿ç”¨åšé“ºå«ã€‚

## ä¸€ éŸ³è§†é¢‘ç¼–è§£ç åŸºæœ¬åŸç†

é¦–å…ˆç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çœ‹è§†é¢‘ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡è§†é¢‘è½¯ä»¶ï¼Œé‚£ä¹ˆä¸€ä¸ªè§†é¢‘æ˜¯å¦‚ä½•ä»è§†é¢‘æœåŠ¡å•†é‚£é‡Œå¼€å§‹ä¼ é€’æœ€ç»ˆè¢«æˆ‘ä»¬çœ‹åˆ°çš„ï¼ŸğŸ¤”

ä¸€èˆ¬è¯´æ¥ï¼Œè§†é¢‘çš„ä¼ é€’åŠè§£ç æœ‰ä»¥ä¸‹å››ä¸ªæµç¨‹ï¼š

- è§£åè®®ï¼šå°†æµåª’ä½“åè®®çš„æ•°æ®ï¼Œè§£ææˆæ ‡å‡†çš„å°è£…æ ¼å¼ã€‚éŸ³è§†é¢‘åœ¨ç½‘ç»œä¸Šä¼ æ’­çš„æ—¶å€™ä¼šå°è£…æˆå„ç§æµåª’ä½“åè®®ï¼Œä¾‹å¦‚HTTPã€RTMPæˆ–è€…MMSç­‰ã€‚è¿™äº›åè®®åœ¨ä¼ é€’éŸ³è§†é¢‘çš„åŒæ—¶è¿˜ä¼šæºå¸¦ä¿¡ä»¤æ•°æ®ï¼ˆæ’­æ”¾æ§åˆ¶ã€ç½‘ç»œçŠ¶æ€ç­‰ä¿¡æ¯ï¼‰ï¼Œè§£
åè®®çš„è¿‡ç¨‹å°±æ˜¯å»æ‰è¿™äº›æ•°æ®ï¼Œä¿ç•™éŸ³è§†é¢‘æ•°æ®ï¼Œä¾‹å¦‚RTMPæµåª’ä½“ç»è¿‡è§£åè®®ï¼Œè¾“å‡ºFLVæ ¼å¼çš„æ•°æ®ã€‚
- è§£å°è£…ï¼šå°†å°è£…å¥½çš„éŸ³è§†é¢‘æ•°æ®åˆ†ç¦»æˆéŸ³é¢‘æµå’Œè§†é¢‘æµï¼Œå°è£…æ ¼å¼ä¹Ÿæ˜¯æˆ‘ä»¬å¸¸è§çš„ï¼Œä¾‹å¦‚MP4ã€MKVã€FLVç­‰ï¼Œå®ƒä»¬çš„ä½œç”¨æ˜¯å°†éŸ³è§†é¢‘æŒ‰ç…§ä¸€å®šçš„æ ¼å¼æ”¾åœ¨ä¸€èµ·ï¼Œä¾‹å¦‚FLVæ ¼å¼çš„æ•°æ®ï¼Œè§£å°è£…ä¹‹åè¾“å‡ºH264è§†é¢‘ç æµå’ŒAAC
éŸ³é¢‘ç æµã€‚
- è§£ç ï¼šå°†å‹ç¼©çš„éŸ³é¢‘æµå’Œè§†é¢‘æµè½¬æ¢ä¸ºéå‹ç¼©çš„éŸ³é¢‘æµå’Œè§†é¢‘æµã€‚éŸ³é¢‘çš„å‹ç¼©æ ‡å‡†åŒ…æ‹¬AACï¼ŒMP3ï¼ŒAC-3ç­‰ï¼Œè§†é¢‘çš„å‹ç¼©æ ‡å‡†åŒ…æ‹¬H.264ï¼ŒMPEG2ï¼ŒVC-1ç­‰ã€‚ç»è¿‡è§£ç å‹ç¼©çš„è§†é¢‘è¾“å‡ºéå‹ç¼©çš„é¢œè‰²æ•°æ®ï¼Œä¾‹å¦‚YUV420Pï¼ŒRGBã€‚
å‹ç¼©çš„éŸ³é¢‘è¾“å‡ºéå‹ç¼©çš„éŸ³é¢‘æŠ½æ ·æ•°æ®ï¼Œä¾‹å¦‚PCMã€‚
- éŸ³è§†é¢‘åŒæ­¥ï¼šæ ¹æ®è§£å°è£…å¾—åˆ°çš„å‚æ•°ä¿¡æ¯ï¼ŒåŒæ­¥è§£ç å‡ºæ¥çš„éŸ³é¢‘è§†é¢‘æ•°æ®ï¼Œå¹¶è¾“å‡ºåˆ°ç³»ç»Ÿçš„æ˜¾å¡å’Œå£°å¡è¿›è¡Œæ’­æ”¾ã€‚

ä¸Šé¢å„ä¸ªæµç¨‹ä¸­éƒ½æœ‰è®¸è®¸å¤šå¤šçš„æ ‡å‡†ï¼Œå°±ç›®å‰çš„æŠ€æœ¯è¶‹åŠ¿è€Œè¨€ï¼Œä¸€èˆ¬ä¼šæœ‰ä»¥ä¸‹é…ç½®ï¼š

- ç›´æ’­å¹³å°ï¼šRTMPæµåª’ä½“åè®® + FLVå°è£…æ ¼å¼ + H.264è§†é¢‘ç¼–ç æ ¼å¼ + AACéŸ³é¢‘ç¼–ç æ ¼å¼
- ç‚¹æ’­å¹³å°ï¼šHTTPæµåª’ä½“åè®® + MP4/FLVå°è£…æ ¼å¼ + H.264è§†é¢‘ç¼–ç æ ¼å¼ + AACéŸ³é¢‘ç¼–ç æ ¼å¼

è¿™é‡Œè¯´ä¸€ä¸‹RTMPä½œä¸ºç‚¹æ’­å¹³å°çš„æµåª’ä½“åè®®ï¼Œåœ¨äºå®ƒå¯¹Flashæ’­æ”¾å»çš„æ”¯æŒï¼Œå› ä¸ºFlashæ’­æ”¾å™¨è¢«ç»å¤§å¤šæ•°æµè§ˆå™¨æ”¯æŒï¼Œå› ä¸ºç®€åŒ–äº†ç›´æ’­å¹³å°å®¢æˆ·ç«¯çš„æ“ä½œã€‚HTTPä½œä¸ºç‚¹æ’­å¹³å°çš„æµåª’ä½“åè®®ï¼Œåœ¨äºHTTPæ˜¯åŸºäºTCP
åè®®çš„åº”ç”¨å±‚åè®®ï¼Œä¿è¯äº†è§†é¢‘ä¼ è¾“çš„è´¨é‡ï¼Œå¦å¤–ï¼ŒHTTPä¹Ÿè¢«å¤§å¤šæ•°WebæœåŠ¡å™¨æ”¯æŒï¼Œç®€åŒ–çš„å®¢æˆ·ç«¯çš„æ’­æ”¾æ“ä½œã€‚

## äºŒ FFmpegæºç ç¼–è¯‘

è€Œæˆ‘ä»¬ä»Šå¤©è¦å­¦ä¹ çš„FFmpegå°±æ˜¯åœ¨éŸ³è§†é¢‘ç¼–è§£ç æ–¹å‘æœ‰ç€ç»Ÿæ²»åœ°ä½çš„ä¸€å¥—æ¡†æ¶ã€‚

>A complete, cross-platform solution to record, convert and stream audio and video.

å®˜æ–¹ç½‘ç«™ï¼šhttp://ffmpeg.org/

åœ¨ç¼–è¯‘FFmpegä¹‹å‰ï¼Œä½ è¦æŒæ¡åœ¨Android Studioä¸Šçš„JNIå¼€å‘ï¼ŒAndroid Studioå¯¹C++çš„æ”¯æŒå·²ç»éå¸¸å¥½äº†ï¼Œæˆ‘ä»¬ç®€å•çš„è¯´ä¸€è¯´ï¼Œæ³¨æ„æˆ‘ä»¬è¿™é‡Œè¯´çš„æ˜¯é€šè¿‡
Android Studioçš„CMakeæ’ä»¶æ¥è¿›è¡ŒJNIå¼€å‘çš„æ–¹å¼ï¼Œè¿™æ˜¯Android Studio 2.2ä»¥åæ¨å‡ºæ¥çš„åŠŸèƒ½ï¼Œè¿™ç§æ–¹å¼åªéœ€è¦ç®€å•çš„é…ç½®å³å¯è¿›è¡Œåº•å±‚å¼€å‘ï¼Œæ— éœ€å†
ç¼–å†™Makefileã€‚

1 é¦–å…ˆåœ¨Android Studioåˆ›å»ºé¡¹ç›®æ—¶ï¼Œé€‰æ‹©æ·»åŠ C++æ”¯æŒï¼Œå¹¶é€‰æ‹©C++ 11.

<img src="https://github.com/guoxiaoxing/phoenix/raw/master/art/ffmpeg/ffmpeg_build_01.png" width="500"/>
<img src="https://github.com/guoxiaoxing/phoenix/raw/master/art/ffmpeg/ffmpeg_build_02.png" width="500"/>

2 ç„¶ååˆ›å»ºå‡ºæ¥çš„é¡¹ç›®æ˜¯è¿™ä¸ªæ ·å­çš„ï¼Œæ¯”å¸¸è§„çš„é¡¹ç›®å¤šäº†cppçš„æºç ç›®å½•ï¼Œä»¥åŠå­˜æ”¾ç¼–è¯‘å‡ºæ¥çš„soåº“çš„ç›®å½•ã€‚

<img src="https://github.com/guoxiaoxing/phoenix/raw/master/art/ffmpeg/ffmpeg_build_03.png" width="500"/>

build.gradleä¹Ÿæœ‰äº›å˜åŒ–ï¼ŒcppFlagsæŒ‡å®šäº†æˆ‘ä»¬ä½¿ç”¨çš„C++ç‰ˆæœ¬ï¼ŒCMakeLists.txtç”¨æ¥å®šåˆ¶åŸç”Ÿä»£ç çš„ã€‚

<img src="https://github.com/guoxiaoxing/phoenix/raw/master/art/ffmpeg/ffmpeg_build_04.png" width="500"/>

æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸‹CMakeLists.txté‡Œé¢çš„ä¿¡æ¯ã€‚

```
# For more information about using CMake with Android Studio, read the
# documentation: https://d.android.com/studio/projects/add-native-code.html

# Sets the minimum version of CMake required to build the native library.

cmake_minimum_required(VERSION 3.4.1)

# Creates and names a library, sets it as either STATIC
# or SHARED, and provides the relative paths to its source code.
# You can define multiple libraries, and CMake builds them for you.
# Gradle automatically packages shared libraries with your APK.


add_library( # è®¾ç½®åº•å±‚åº“çš„åå­—ï¼ŒJavaå±‚loadLibrary()æ—¶ä½¿ç”¨
             native-lib

             # è®¾ç½®è¿™ä¸ªåº“æ˜¯åŠ¨æ€åº“è¿˜æ˜¯é™æ€åº“
             SHARED

             # è®¾ç½®ç¼–è¯‘è¿™ä¸ªåº“æ‰€éœ€çš„æºç ç›®å½•
             src/main/cpp/native-lib.cpp )

# Searches for a specified prebuilt library and stores the path as a
# variable. Because CMake includes system libraries in the search path by
# default, you only need to specify the name of the public NDK library
# you want to add. CMake verifies that the library exists before
# completing its build.

find_library( # find_libraryä¸»è¦ç”¨æ¥å¼•ç”¨å…¶ä»–åº•å±‚åº“ï¼Œè¿™é‡Œå¼•ç”¨çš„æ˜¯åº•å±‚logåº“
              log-lib

              # Specifies the name of the NDK library that
              # you want CMake to locate.
              log )

# Specifies libraries CMake should link to your target library. You
# can link multiple libraries, such as libraries you define in this
# build script, prebuilt third-party libraries, or system libraries.

target_link_libraries( # æŒ‡å®šè¦å…³è”åˆ°åŸç”Ÿåº“çš„åº“
                       native-lib

                       # Links the target library to the log library
                       # included in the NDK.
                       ${log-lib} )
```

æ›´å¤šå…³äºCMakeçš„ä¿¡æ¯å¯ä»¥å‚è€ƒï¼šhttps://developer.android.google.cn/ndk/guides/cmake.html

3 ç­‰ä½ åšå®Œä»¥ä¸Šçš„äº‹æƒ…ï¼Œå‰©ä¸‹çš„äº‹æƒ…å°±ä¸€ç›®äº†ç„¶äº†ï¼Œæ€»ä½“æ¥è¯´CMakeæ’ä»¶çš„æ–¹å¼æå¤§çš„ç®€åŒ–äº†åº•å±‚çš„å¼€å‘ï¼Œæ¨èå¤§å®¶ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚

<img src="https://github.com/guoxiaoxing/phoenix/raw/master/art/ffmpeg/ffmpeg_build_05.png"/>

