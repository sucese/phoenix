# Androidå¹³å°å›¾åƒå‹ç¼©æ–¹æ¡ˆ

**å…³äºä½œè€…**

>éƒ­å­æ˜Ÿï¼Œç¨‹åºå‘˜ï¼Œå‰ä»–æ‰‹ï¼Œä¸»è¦ä»äº‹Androidå¹³å°åŸºç¡€æ¶æ„æ–¹é¢çš„å·¥ä½œï¼Œæ¬¢è¿äº¤æµæŠ€æœ¯æ–¹é¢çš„é—®é¢˜ï¼Œå¯ä»¥å»æˆ‘çš„[Github](https://github.com/guoxiaoxing)æissueæˆ–è€…å‘é‚®ä»¶è‡³guoxiaoxingse@163.comä¸æˆ‘äº¤æµã€‚

**æ–‡ç« ç›®å½•**

åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œè§†é¢‘çš„å‹ç¼©ä¸ä¸Šä¼ ä¹Ÿæ˜¯å¸¸è§çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå› ä¸ºè§†é¢‘æœ‰ç€æ¯”å›¾åƒæ›´å¼ºçš„è¡¨ç°åŠ›ï¼Œä¹Ÿå°±æ›´å—äº§å“éœ€æ±‚çš„é’çã€‚ä½†æ˜¯Androidå¹³å°è§†é¢‘ç›¸å…³çš„å¼€å‘ï¼Œå¤§æ¦‚æ˜¯æ•´ä¸ªAndroidç”Ÿæ€æœ€ä¸º
åˆ†è£‚ï¼Œå…¼å®¹æ€§é—®é¢˜æœ€ä¸ºçªå‡ºçš„ä¸€éƒ¨åˆ†ã€‚ä¸åŒå‚å•†å¯¹æ‘„åƒé‡‡é›†ä»¥åŠç¼–è§£ç çš„å®ç°æœ‰å¾ˆå¤§å·®å¼‚ï¼Œè¿™ç»™æˆ‘ä»¬åœ¨é€‚é…ä¸Šå¸¦æ¥äº†å¾ˆå¤§çš„éº»çƒ¦ã€‚ä»Šå¤©æˆ‘ä»¬å°±è¿™äº›é—®é¢˜è®¨è®ºè§†é¢‘å‹ç¼©æ–¹æ¡ˆçš„å®ç°ã€‚

é¦–å…ˆè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹å’Œè§†é¢‘å‹ç¼©ç›¸å…³çš„åŸºç¡€ç†è®ºã€‚

## ä¸€ è§†é¢‘å‹ç¼©åŸºç¡€ç†è®º

ç¼–è§£ç å™¨

- ç¼–ç å™¨ï¼ˆEncoderï¼‰ï¼šå‹ç¼©ä¿¡å·çš„è®¾å¤‡æˆ–ç¨‹åºï¼›
- è§£ç å™¨ï¼ˆDecoderï¼‰ï¼šè§£å‹ç¼©ä¿¡å·çš„è®¾å¤‡æˆ–ç¨‹åºï¼›
- ç¼–è§£ç å™¨(Codec)ï¼šç¼–è§£ç å™¨å¯¹ã€‚

å‹ç¼©åˆ†ç±»

- æ— æŸå‹ç¼©ï¼ˆLosslessï¼‰ï¼šå‹ç¼©å‰ã€è§£å‹ç¼©åå›¾åƒå®Œå…¨ä¸€è‡´X=X'ï¼Œå‹ç¼©æ¯”ä½(2:1~3:1)ã€‚å…¸å‹æ ¼å¼ä¾‹å¦‚ï¼šWinzipï¼ŒJPEG-LSã€‚
- æœ‰æŸå‹ç¼©ï¼ˆLossyï¼‰ï¼šå‹ç¼©å‰è§£å‹ç¼©åå›¾åƒä¸ä¸€è‡´Xâ‰ X'ï¼Œå‹ç¼©æ¯”é«˜(10:1~20:1)ï¼Œåˆ©ç”¨äººçš„è§†è§‰ç³»ç»Ÿçš„ç‰¹æ€§ã€‚å…¸å‹æ ¼å¼ä¾‹å¦‚ï¼šMPEG-2ï¼ŒH.264/AVCï¼ŒAVSã€‚

äº†è§£äº†è¿™äº›åŸºç¡€çš„æ¦‚å¿µï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸¤ä¸ªé—®é¢˜ã€‚

é¦–å…ˆæ¥è¯´ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦å‹ç¼©è§†é¢‘ï¼ŸğŸ¤”

- æœªç»å‹ç¼©çš„è§†é¢‘å¸¦æœ‰å¤§é‡ä¿¡æ¯ï¼Œå¯èƒ½ä¼šæ³„æ¼ç”¨æˆ·éšç§ï¼Œè¿™å’Œå›¾åƒæ˜¯ä¸€æ ·çš„ã€‚
- æœªç»å‹ç¼©çš„è§†é¢‘ä¼šå ç”¨å¤§é‡å­˜å‚¨ç©ºé—´ï¼Œç°åœ¨çš„æ‰‹æœºéƒ½1080Pç”šè‡³4kï¼Œå¦‚æœä¸åšå‹ç¼©ï¼Œè§†é¢‘è¯»å†™çš„æ—¶å€™ä¹Ÿå¯èƒ½ä¼šæŠ¥OOMã€‚
- æœªç»å‹ç¼©çš„è§†é¢‘ä¼šåœ¨ä¼ è¾“æ—¶ä¼šå ç”¨å¤§é‡å¸¦å®½ï¼Œä¸€ä¸ª60sçš„è§†é¢‘å¯è¾¾åˆ°å‡ åMçš„å¤§å°ï¼Œç›´æ¥ä¸Šä¼ å‡ åMçš„æ–‡ä»¶ä¼šç»™ç”¨æˆ·å¸¦æ¥å¾ˆå¤§çš„æµé‡æ¶ˆè€—ï¼Œæ¥å£æœ¬èº«ä¹Ÿå¾ˆå®¹æ˜“è¶…æ—¶ã€‚

å†æ¥çœ‹çœ‹ç¬¬äºŒä¸ªé—®é¢˜ï¼Œè§†é¢‘å‹ç¼©åˆ°åº•å‹ç¼©äº†ä»€ä¹ˆï¼ŸğŸ¤”

- ç©ºé—´å†—ä½™ï¼šå›¾åƒç›¸é‚»åƒç´ ä¹‹é—´æœ‰è¾ƒå¼ºçš„ç›¸å…³æ€§
- æ—¶é—´å†—ä½™ï¼šè§†é¢‘åºåˆ—çš„ç›¸é‚»å›¾åƒä¹‹é—´å†…å®¹ç›¸ä¼¼
- ç¼–ç å†—ä½™ï¼šä¸åŒåƒç´ å€¼å‡ºç°çš„æ¦‚ç‡ä¸åŒ
- è§†è§‰å†—ä½™ï¼šäººçš„è§†è§‰ç³»ç»Ÿå¯¹æŸäº›ç»†èŠ‚ä¸æ•æ„Ÿ
- çŸ¥è¯†å†—ä½™ï¼šè§„å¾‹æ€§çš„ç»“æ„å¯ç”±å…ˆéªŒçŸ¥è¯†å’ŒèƒŒæ™¯çŸ¥è¯†å¾—åˆ°

## äºŒ è§†é¢‘å‹ç¼©æ–¹æ¡ˆå®ç°

Androidå¹³å°å¯¹äºè§†é¢‘ç¼–è§£ç è€Œè¨€ï¼Œå¸¸è§çš„æ–¹æ¡ˆé€‰æ‹©æœ‰ä¸¤ç§ï¼š

- MediaCodecï¼šAndroidäºAPI 16ä¹‹åæ¨å‡ºçš„ç”¨äºéŸ³è§†é¢‘ç¼–è§£ç çš„ä¸€å¥—åº•å±‚APIï¼Œå¯ä»¥åˆ©ç”¨ç¡¬ä»¶åŠ é€Ÿè¿›è¡Œç¼–è§£ç ï¼Œå®ƒçš„ä¼˜ç‚¹æ˜¯ç³»ç»Ÿè‡ªå¸¦ï¼Œä¸ç”¨å¼•ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œ
- FFMpeg + x264/openh264ï¼šFFMpegå¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ï¼Œè¿™é‡Œä¸€èˆ¬ç”¨FFMpegåšè§†é¢‘å¸§çš„é¢„å¤„ç†ï¼Œç„¶åå†ä½¿ç”¨x264/openh264ä½œä¸ºè§†é¢‘çš„ç¼–ç å™¨ï¼Œ

å…³äºx264

>[x264](https://www.videolan.org/developers/x264.html)æ˜¯ä¸€ä¸ªé‡‡ç”¨GPLæˆæƒçš„è§†é¢‘ç¼–ç è‡ªç”±è½¯ä½“ã€‚x264çš„ä¸»è¦åŠŸèƒ½åœ¨äºè¿›è¡ŒH.264/MPEG-4 AVCçš„è§†é¢‘ç¼–ç ï¼Œè€Œä¸æ˜¯ä½œä¸ºè§£ç å™¨ï¼ˆdecoderï¼‰ä¹‹ç”¨ã€‚å®ƒåŸºæœ¬æ”¯æŒh264çš„
æ‰€æœ‰ç‰¹æ€§ã€‚

å…³äºopenh264

>[openh264](http://www.openh264.org/)ï¼šæ˜¯ç”±æ€ç§‘å¼€æºçš„å¦å¤–ä¸€ä¸ªh264ç¼–ç å™¨ï¼Œä½†å¯¹æ¯”èµ·x264ï¼Œopenh264åœ¨h264é«˜çº§ç‰¹æ€§çš„æ”¯æŒç›¸å¯¹è¾ƒå·®ã€‚

è½¯è§£æœ€å¤§çš„é—®é¢˜å°±æ˜¯ç¼–è§£ç æ•ˆç‡çš„é—®é¢˜ï¼Œå› ä¸ºAndroidæ‰‹æœºè‡ªèº«çš„é™åˆ¶ï¼Œå®ƒåªèƒ½ä½¿ç”¨CPUå¯¹è§†é¢‘è¿›è¡Œé€å¸§å›¾åƒå¤„ç†ï¼Œæ•ˆç‡éå¸¸çš„ä½ï¼Œå¯ä»¥è¯´åœ¨äº§å“ä½¿ç”¨ä¸Šæ˜¯éš¾ä»¥è®©äººæ¥å—çš„ã€‚æœ¬ç¯‡æ–‡ç« ä¸»è¦
è®¨è®ºAndroidè§†é¢‘å‹ç¼©ç¡¬è§£ç çš„å®ç°ï¼Œå¦‚æœå¯¹è½¯è§£ç æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒä¸‹è¿™ä¸ªé¡¹ç›®[small-video-record](https://github.com/mabeijianxi/small-video-record)

å®ƒçš„å‹ç¼©åŸç†æœ¬è´¨ä¸Šæ¥è¯´å°±æ˜¯åˆ©ç”¨FFmpegçš„å‘½ä»¤è¡Œå°±è¡Œè§†é¢‘çš„é‡æ–°ç¼–è§£ç å¤„ç†ï¼Œæ”¹å˜è§†é¢‘çš„å¤§å°ï¼Œå¸§ç‡ä»è€Œè¾¾åˆ°å‹ç¼©çš„ç›®çš„ï¼Œå®ƒçš„ç¼–è§£ç å‘½ä»¤æ˜¯ï¼š

>ffmpeg -threads 16 -i /storage/emulated/0/DCIM/Camera/VID_20171120_110201.mp4 -c:v libx264  -crf 28 -preset ultrafast  -c:a libfdk_aac  -vbr 4    /storage/emulated/0/DCIM/souche/1511155800958/1511155800958.mp4

æˆ‘ä»¬æ¥ç€è¿›å…¥ä»Šå¤©çš„æ­£é¢˜ï¼šåŸºäºMediaCodecçš„Androidå¹³å°è§†é¢‘å‹ç¼©æ–¹æ¡ˆçš„å®ç°ã€‚

>[MediaCodec](https://developer.android.com/reference/android/media/MediaCodec.html)æ˜¯ä¸€å¥—ååº•å±‚çš„éŸ³è§†é¢‘ç¼–è§£ç å™¨ï¼Œå¯ä»¥åˆ©ç”¨ç¡¬ä»¶åŠ é€Ÿè¿›è¡Œç¡¬è§£ç ã€‚

<img src="https://github.com/guoxiaoxing/phoenix/raw/master/art/codec/MediaCodec.png"/>


MediaCodecç­‰ä¸€ç³»åˆ—çš„ç±»ä¸»è¦ç”¨æ¥ç¼–è§£ç éŸ³è§†é¢‘ï¼Œæ•´ä¸ªå®¶æ—æˆå‘˜ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªç±»ï¼š

- MediaCodecï¼šç”¨æ¥è®¿é—®åº•å±‚åª’ä½“ç¼–è§£ç å™¨ï¼Œå³ç¼–ç å™¨/è§£ç å™¨çš„éƒ¨ä»¶ã€‚
- MediaExtractor
- MediaSync
- MediaMuxer
- MediaCrypto
- MediaDrm
- Image
- Surface
- AudioTrack